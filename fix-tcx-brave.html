<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TCX Workout Fixer (Brave Compatible)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0; padding: 10px; background: #f0f2f5; font-size: 16px;
    }
    .container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { color: #1a1a1a; margin: 10px 0 5px; font-size: 24px; }
    .section { margin: 15px 0; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background: #fafafa; }
    .section h3 { margin: 0 0 12px; font-size: 18px; color: #333; }
    label { display: block; margin: 12px 0 6px; font-weight: 600; color: #555; font-size: 14px; }
    input[type="number"], input[type="file"] { 
      padding: 12px; margin: 8px 0; width: 100%; border: 1px solid #ccc; border-radius: 6px; 
      font-size: 16px; -webkit-appearance: none; appearance: none;
    }
    input[type="file"] { padding: 10px; cursor: pointer; }
    button { 
      padding: 14px 20px; margin: 8px 0; width: 100%; background: #0078d4; color: white; 
      border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600;
      touch-action: manipulation; -webkit-user-select: none;
    }
    button:active { background: #005a9e; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #dropZone { 
      border: 2px dashed #0078d4; padding: 50px 15px; text-align: center; border-radius: 8px; 
      background: #f0f7ff; margin: 15px 0; cursor: pointer; transition: background 0.2s; 
      min-height: 120px; display: flex; align-items: center; justify-content: center;
    }
    #dropZone p { margin: 0; font-size: 16px; line-height: 1.5; }
    #dropZone small { font-size: 13px; display: block; margin-top: 8px; }
    #dropZone.dragover { background: #e8f4ff; border-color: #00a4ef; }
    #dropZone.dragging { background: #cce5ff; border-color: #0078d4; font-weight: bold; }
    #log { 
      background: #1a1a1a; color: #00ff00; padding: 12px; border-radius: 6px; 
      max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 11px; 
      line-height: 1.4; white-space: pre-wrap; word-wrap: break-word;
    }
    .info { background: #e3f2fd; color: #1565c0; padding: 12px; border-radius: 6px; margin: 10px 0; font-size: 14px; }
    .file-item { 
      background: #f5f5f5; padding: 10px; margin: 8px 0; border-radius: 6px; border-left: 4px solid #0078d4; 
      font-size: 14px; display: flex; justify-content: space-between; align-items: center;
    }
    .file-name { font-weight: 500; }
    .file-steps { color: #0078d4; font-weight: 600; }
    @media (max-width: 600px) {
      body { padding: 8px; }
      .container { padding: 12px; }
      h1 { font-size: 20px; }
      .section { padding: 12px; margin: 10px 0; }
      button { padding: 12px 16px; font-size: 15px; }
      #dropZone { padding: 40px 10px; min-height: 100px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèÉ TCX Workout Fixer (Compatible Brave)</h1>
    <div class="info">
      <strong>Mode Drag & Drop :</strong> Glissez vos fichiers .tcx ou dossier SRC ici pour traiter les workouts.
    </div>

    <div class="section">
      <h3>‚öôÔ∏è Configuration</h3>
      <label>Poids (kg) :</label>
      <input id="weightInput" type="number" value="70" min="30" max="200" step="1">
      
      <label>Pas / km :</label>
      <input id="stepsPerKmInput" type="number" value="1250" min="500" max="2000" step="50">
    </div>

    <div class="section">
      <h3>üìÅ S√©lectionner fichiers</h3>
      <label for="fileInput">Fichiers .tcx :</label>
      <input id="fileInput" type="file" multiple accept=".tcx" />
      
      <div style="margin-top: 15px; padding: 10px; background: #e8f5e9; border-radius: 6px; font-size: 13px; color: #2e7d32;">
        üìù <strong>Ou glissez-d√©posez</strong> vos fichiers .tcx ici :
      </div>
      <div id="dropZone">
        <p style="font-size: 16px; margin: 0;">
          üìÇ Glissez vos fichiers<br>
          <small style="color: #666; font-size: 12px;">fichiers .tcx</small>
        </p>
      </div>
    </div>

    <div class="section">
      <h3>üìã Fichiers charg√©s</h3>
      <div id="filesList" style="min-height: 30px; color: #999; font-size: 14px;">
        Aucun fichier s√©lectionn√©
      </div>
    </div>

    <div class="section">
      <h3>üìä Logs</h3>
      <div id="log"></div>
    </div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const filesList = document.getElementById('filesList');
    const weightInput = document.getElementById('weightInput');
    const stepsPerKmInput = document.getElementById('stepsPerKmInput');

    let processedFiles = [];

    function log(...args) {
      const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
      const now = new Date().toLocaleTimeString();
      logEl.innerHTML += `[${now}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateFilesList() {
      if (processedFiles.length === 0) {
        filesList.innerHTML = '<span style="color: #999;">Aucun fichier s√©lectionn√©</span>';
        return;
      }
      let html = '';
      processedFiles.forEach(f => {
        html += `<div class="file-item"><span class="file-name">‚úì ${f.name}</span> <span class="file-steps">${f.estimatedSteps} pas</span></div>`;
      });
      filesList.innerHTML = html;
    }

    // File input
    fileInput.addEventListener('change', async (e) => {
      processedFiles = [];
      const files = Array.from(e.target.files).filter(f => f.name.toLowerCase().endsWith('.tcx'));
      
      if (files.length === 0) {
        log('‚ùå Aucun fichier .tcx s√©lectionn√©');
        return;
      }

      log(`üì• Traitement de ${files.length} fichier(s)...`);
      for (const file of files) {
        await processFile(file);
      }
      updateFilesList();
      log(`‚úÖ ${processedFiles.length} fichier(s) pr√™t(s)`);
    });

    // Drag and drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');

      const files = Array.from(e.dataTransfer.files).filter(f => f.name.toLowerCase().endsWith('.tcx'));
      
      if (files.length === 0) {
        log('‚ùå Aucun fichier .tcx d√©tect√©');
        return;
      }

      processedFiles = [];
      log(`üì• Traitement de ${files.length} fichier(s)...`);
      
      for (const file of files) {
        await processFile(file);
      }
      
      updateFilesList();
      log(`‚úÖ ${processedFiles.length} fichier(s) pr√™t(s)`);
    });

    async function processFile(file) {
      try {
        let s = await file.text();

        // Changer Sport="Other" en Sport="Running"
        s = s.replace(/(<Activity\b[^>]*\bSport=")([^"]*)(")/i, '$1Running$3');

        // Extraire max distance depuis les Trackpoints
        const tpRegex = /<Trackpoint\b[\s\S]*?<DistanceMeters>([\d.]+)<\/DistanceMeters>[\s\S]*?<\/Trackpoint>/gi;
        let m;
        let max = 0;
        while ((m = tpRegex.exec(s)) !== null) {
          const val = parseFloat(m[1]);
          if (!isNaN(val) && val > max) max = val;
        }

        // √âcrire max distance dans Lap
        if (max > 0) {
          const lapDistRegex = /(<Lap\b[^>]*>[\s\S]*?<DistanceMeters>)([\d.]+)(<\/DistanceMeters>[\s\S]*?<\/Lap>)/i;
          if (lapDistRegex.test(s)) {
            s = s.replace(lapDistRegex, function(_, a, _old, b) { return a + String(max) + b; });
          } else {
            s = s.replace(/(<Lap\b[^>]*>)/i, function(m0) { return m0 + '\n      <DistanceMeters>' + String(max) + '</DistanceMeters>'; });
          }
        }

        // Calculer pas depuis distance
        const stepsPerKmVal = parseFloat(stepsPerKmInput.value) || 1250;
        let estimatedSteps = 0;
        if (max > 0) {
          estimatedSteps = Math.round((max / 1000) * stepsPerKmVal);
        }

        const cadenceRegex = /<Cadence>([\d.]+)<\/Cadence>/gi;
        let c;
        const cadences = [];
        while ((c = cadenceRegex.exec(s)) !== null) {
          cadences.push(parseFloat(c[1]));
        }
        const avgCadence = cadences.length ? (cadences.reduce((a, b) => a + b, 0) / cadences.length) : 0;

        processedFiles.push({
          name: file.name,
          content: s,
          estimatedSteps,
          avgCadence: Math.round(avgCadence * 100) / 100,
          distance: max
        });

        log(`  ‚úì ${file.name}: ${estimatedSteps} pas (${max}m)`);
      } catch (err) {
        log(`  ‚úó ${file.name}: ${err.message}`);
      }
    }

    // G√©n√©rer ZIP
    async function generateZip() {
      if (processedFiles.length === 0) {
        log('‚ùå Aucun fichier √† t√©l√©charger');
        return;
      }

      try {
        log('üì¶ Cr√©ation du ZIP...');
        const zip = new JSZip();

        processedFiles.forEach(f => {
          zip.file(f.name, f.content);
        });

        // Cr√©er summary.txt
        let txt = '';
        processedFiles.forEach(e => {
          txt += `${e.name}: ${e.estimatedSteps} pas\n`;
        });
        zip.file('summary.txt', txt);

        // G√©n√©rer et t√©l√©charger
        const blob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'fixed-tcx-files.zip';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        log('‚úÖ ZIP t√©l√©charg√© ‚Äî extraire dans votre dossier FINAL');
      } catch (e) {
        log('‚ùå Erreur ZIP:', e.message);
      }
    }

    log('‚úÖ App pr√™te.');
    log('üì± S√©lectionnez des fichiers .tcx');
    
    // Ajouter bouton ZIP dynamiquement dans section logs
    const logsSection = document.querySelector('.section:has(#log)');
    const zipBtnDiv = document.createElement('div');
    zipBtnDiv.style.marginTop = '15px';
    zipBtnDiv.innerHTML = '<button id="zipBtn" onclick="generateZip()" style="background: #28a745;">‚¨áÔ∏è T√©l√©charger ZIP</button>';
    logsSection.appendChild(zipBtnDiv);
  </script>
</body>
</html>
